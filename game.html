<!DOCTYPE html>
<html lang = de>
<head>
	<Title>AVPRG</title>
    <meta charset=utf-8>
    <link rel=stylesheet href=stylesheet.css type=text/css>
    <!-- Level-Datei Importe -->
    <script type="text/javascript" src="LevelData/wewillrockyou.js"></script>
    <script type="text/javascript" src="LevelData/heathens.js"></script>
    <script type="text/javascript" src="LevelData/heathenshard.js"></script>
</head>
<body>
    <div id=overlay><!-- Endresultat Overlay -->
        <div id=text></div>
        <button class= overlayButtons id=overlayBackButton onclick="location.href='index.html'">Hauptmenü</button>
        <button class= overlayButtons id=overlayRetryButton1 onclick="location.reload()">Noch einmal</button>
    </div>
    <div id=overlayPause><!-- Pausemenü Overlay -->
        <div id=text>Pause</div>
        <button class= overlayButtons id=overlayBackButton onclick="location.href='index.html'">Hauptmenü</button>
        <button class= overlayButtons id=overlayRetryButton1 onclick="location.reload()">Noch einmal</button>
    </div>
    <!-- Trefferpunkte Overlay -->	
    <div id=overlay300 class=overlayPoints>
        <div id=text>300</div>
    </div>
    <div id=overlay100 class=overlayPoints>
        <div id=text>100</div>
    </div>
    <div id=overlay50 class=overlayPoints>
        <div id=text>50</div>
    </div>
    <div id=overlayMiss class=overlayPoints>
        <div id=text>Miss</div>
    </div>
    <!-- Lebensbalken erstellen -->
    <progress id=healthBar value=100 max=100></progress>
    <!-- Canvas erstellen -->	
    <canvas id=canvas width=1200 height=800></canvas>
    <!-- UI Tasten erstellen -->
    <div id=keyUI>
        <div class=playKeys id=playKey1>D</div>
        <div class=playKeys id=playKey2>F</div>
        <div class=playKeys id=playKey3>J</div>
        <div class=playKeys id=playKey4>K</div>
        <div class=colorInd id=ind1></div>
        <div class=colorInd id=ind2></div>
        <div class=colorInd id=ind3></div>
        <div class=colorInd id=ind4></div>
    </div>
    <script>
	//Standard-Levelwerte
        const FPS = 30;
        const playerSize = 70;			//in px
	var indicatorPosition = 0;		//X-Koordinate des Indikators
	var message = "Score: 0";
	var cooldown = false;			//Cooldown für Treffer
        var activeGap = 0;			//X-Koordinate der nächsten zu treffenden Lücke
	var firstClickDone = false;		//Wird true wenn aktuelle Lücke getroffen wird
        var noDeath = false;			//Erfolgreicher Levelabschluss
        var score = 0;
        var endDelay = 0;			//Delay für das Endresultat Overlay in Frames
        var gameOver = false;
	var overlayTimer = 0;			//Anzeigedauer vom Trefferpunkte Overlay in Frames
        var mouseInactiveTimer = 0;		//Inaktivitätsdauer des Mauszeigers in Frames(Ausblenden nach 70 Frames)
	var hit300 = 0;				//Anzahl der jeweiligen Treffertypen
        var hit100 = 0;
        var hit50 = 0;
        var hit0 = 0;
	    
	//Spieltasten und Tastenstatus
        var btn1 = document.querySelector("#playKey1");
        var btn2 = document.querySelector("#playKey2");
        var btn3 = document.querySelector("#playKey3");
        var btn4 = document.querySelector("#playKey4");
	var btnDown1 = false;
        var btnDown2 = false;
        var btnDown3 = false;
        var btnDown4 = false;
	
	//Leveleigenschaften
	var levelNr;				//ID des Levels
        var scrollSpeed;			//Lückengeschwindigkeit in px pro Frame
        var gapWidth;				//Breite der Lücken in px
        var firstNoteDistance;			//Distanz zur ersten Lücke in px
	var sound1;				//Tastentöne
        var sound2;
        var sound3;
        var sound4;
	var backgroundSound;			//Hintergrundmusik
	var backgroundDelay;			//Delay der Hintergrundmusik
	    
        //Hintergrundmusik
	var context = new AudioContext();
	var request = new XMLHttpRequest();
        var sourceBuffer = context.createBufferSource();
        
        //Canvas
        var canv = document.getElementById("canvas");
        var ctx = canv.getContext("2d");
        ctx.font = "20px Arial";

	//Spieler und Lücken-Arrays
        var player;				//Spielerkoordinaten und -dimensionen in px
        var platforms = [];
        var platPos = [];
        var platCol = [];

        setup();
	    
    function setup()
    {
        player = 
        {
            x: canv.width / 8,
            y: canv.height / 2,
            width: playerSize,
            height: playerSize * 1.5
        }
        indicatorPosition = player.x * 2.2;
        
        if(window.location.href.includes("WeWillRockYou"))
        {
            levelNr = 1;
            //Schwierigkeitsgrad
            scrollSpeed = lvl1SS;
            gapWidth = lvl1GW;
            firstNoteDistance = lvl1FND;

            //Audio
            backgroundSound = lvl1BS;
            backgroundDelay = lvl1BD;
            sound1 = lvl1Sound1;
            sound2 = lvl1Sound2;

            //UI
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
            document.getElementById("ind1").style.backgroundColor = "rgba(0,0,0,0.0)";
            document.getElementById("ind4").style.backgroundColor = "rgba(0,0,0,0.0)";
        }
        else if(window.location.href.includes("Heathens"))
        {
            levelNr = 2;
            //Schwierigkeitsgrad
            scrollSpeed = lvl2SS;
            gapWidth = lvl2GW;
            firstNoteDistance = lvl2FND;

            //Audio
            backgroundSound = lvl2BS;
            backgroundDelay = lvl2BD;
            sound1 = lvl2Sound1;
            sound2 = lvl2Sound2;
            sound3 = lvl2Sound3;
            
            //UI
            btn1.style.backgroundColor = "rgb(189, 207, 221)";
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
            document.getElementById("ind4").style.backgroundColor = "rgba(0,0,0,0.0)";
        }
        else if(window.location.href.includes("Hardmode"))
        {
            levelNr = 3;
            //Schwierigkeitsgrad
            scrollSpeed = lvl3SS;
            gapWidth = lvl3GW;
            firstNoteDistance = lvl3FND;

            //Audio
            backgroundSound = lvl3BS;
            backgroundDelay = lvl3BD;
            sound1 = lvl3Sound1;
            sound2 = lvl3Sound2;
            sound3 = lvl3Sound3;
            sound4 = lvl3Sound4;
            
            //UI
            btn1.style.backgroundColor = "rgb(189, 207, 221)";
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
            document.getElementById("ind4").style.backgroundColor = "rgba(0,0,0,0.0)";
        }

        //Hintergrundmusik
	var gainNode = context.createGain();
        request.open('GET', backgroundSound, true);
	request.responseType = 'arraybuffer';
        request.onload = function () 
        {
	    var undecodedAudio = request.response;
            context.decodeAudioData(undecodedAudio, function(buffer) 
            {
	    	sourceBuffer.buffer = buffer;
		sourceBuffer.connect(gainNode);
		gainNode.connect(context.destination);
                gainNode.gain.value = localStorage.musicVolume * 0.01;
                sourceBuffer.start(context.currentTime + backgroundDelay);
	    });
	};
        request.send();

	//Füllt Lückenarray mit Daten der Lücken aus der Level-Datei
        readLevelData();
	    
	    
        //Erstellt Gameloop
        setInterval(update, 1000 / FPS);
    }

    function update()
    {
        if(!gameOver)
        {
            //Zeichne Hintergrund
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canv.width, canv.height);

            //Zeichne Plattform
            ctx.fillStyle = "white";
            ctx.fillRect(0, player.y+playerSize / 20, canv.width, 30);

            //Zeichne Score-Text
            ctx.fillStyle = "white";
            ctx.fillText(message, canv.width - 180, 50);

            //Zeichne Spieler
            ctx.fillStyle = "green";
            ctx.fillRect(player.x, player.y - player.height, player.width, player.height);
            ctx.strokeStyle = "white";
            ctx.lineWidth = playerSize / 20;
            ctx.beginPath();
            ctx.moveTo(player.x, player.y);
            ctx.lineTo(player.x + player.width, player.y);
            ctx.lineTo(player.x + player.width, player.y - player.height);
            ctx.lineTo(player.x, player.y - player.height);
            ctx.lineTo(player.x, player.y);
            ctx.stroke();
            
            //Berechne neue Lückenpositionen
            calcFloor();
		
	    //Berechne aktive Lücke	
            calcNextGap();

            //Zeichne Lücken
            for(var i = 0; i < platforms.length; i++)
            {
                if(platforms[i] < canv.width && platforms[i] > 0 - gapWidth)
                {
                    ctx.fillStyle = platCol[i]; 
                    ctx.fillRect(platforms[i], player.y+playerSize / 20, gapWidth, 30);
                }
            }

            //Zeichne Indikator
            ctx.strokeStyle = "red";
            ctx.lineWidth = playerSize / 10;
            ctx.beginPath();
            ctx.moveTo(player.x * 2.2, player.y - player.height * 1.5);
            ctx.lineTo(player.x * 2.2, player.y + player.height / 2);
            ctx.stroke();

	    //Zeichne und Aktualisiere Lebensbalken
            if(!noDeath)document.getElementById("healthBar").value -= 0.3;

	    //Beende Level
            if(activeGap == platforms.length - 1)
            {
                endDelay++;
                noDeath = true;
                if(endDelay == 60)levelEnd("finish");
            }
		
	    //Trefferpunkte Overlay anzeigen
            if(overlayTimer > 0)
            {
                if(overlayTimer < 8)
                {
                    overlayTimer++;
                }
                else
                {
                    document.getElementById("overlay300").style.display = "none";
                    document.getElementById("overlay100").style.display = "none";
                    document.getElementById("overlay50").style.display = "none";
                    document.getElementById("overlayMiss").style.display = "none";
                    overlayTimer = 0;
                }
            }
		
	    //Berechnung der Inaktivitätsdauer des Mauszeigers
            mouseInactiveTimer++;
	    //Ausblenden nach 70 Frames
            if(mouseInactiveTimer > 70)
            {
                document.querySelector("#canvas").style.cursor = "url('Assets/cursor2.png')64 64, auto";
            }
		
	    //Beende Level wenn Lebenspunkte auf 0 fallen
            if(document.getElementById("healthBar").value < 1)
            {
                levelEnd("dead");
            }
        }
    }

    window.onmousemove = function(e)
    {
        mouseInactiveTimer = 0;
        document.querySelector("#canvas").style.cursor = "url('Assets/cursor.png')64 64, auto";
    }
	    
    window.onkeydown = function(e)
    {
        var key = e.keyCode ? e.keyCode : e.which;

        if(key == 27) //27 = 'Escape' lässt das Pause Overlay erscheinen
        {
            document.getElementById("overlayPause").style.display = "block";
        }
	    
	//Spieltasten werden rot gefärbt, spielen Audio ab und Trefferüberprüfung wird ausgelöst   
        if(key == 68 && !gameOver && levelNr == 2 || key == 68 && !gameOver && levelNr == 3) //68 = 'D'
        {
            btn1.style.backgroundColor = "lightcoral";
            checkHit(68);                               
            if(!btnDown1)
            {
                var context = new AudioContext();
                sound = new Audio(sound3);
                soundNote = context.createMediaElementSource(sound);
                var gainNode = context.createGain();
                gainNode.gain.value = localStorage.effectVolume * 0.01;
                soundNote.connect(gainNode);
                gainNode.connect(context.destination);
                sound.play();
            }
            btnDown1 = true;
        }
        if(key == 70 && !gameOver) //70 = 'F'
        {
            btn2.style.backgroundColor = "lightcoral";
            checkHit(70);
            if(!btnDown2)
            {
                var context = new AudioContext();
                sound = new Audio(sound1);
                soundNote = context.createMediaElementSource(sound);
                var gainNode = context.createGain();
                gainNode.gain.value = localStorage.effectVolume * 0.01;
                soundNote.connect(gainNode);
                gainNode.connect(context.destination);
                sound.play();
            }
            btnDown2 = true;
        }
        if(key == 74 && !gameOver) //74 = 'J'
        {
            btn3.style.backgroundColor = "lightcoral";
            checkHit(74);
            if(!btnDown3)
            {
                var context = new AudioContext();
                sound = new Audio(sound2);
                soundNote = context.createMediaElementSource(sound);
                var gainNode = context.createGain();
                gainNode.gain.value = localStorage.effectVolume * 0.01;
                soundNote.connect(gainNode);
                gainNode.connect(context.destination);
                sound.play();
            }
            btnDown3 = true;
        }
        if(key == 75 && !gameOver && levelNr == 3) //75 = 'K'
        {
            btn4.style.backgroundColor = "lightcoral";
            checkHit(75);
            if(!btnDown4)
            {
                var context = new AudioContext();
                sound = new Audio(sound4);
                soundNote = context.createMediaElementSource(sound);
                var gainNode = context.createGain();
                gainNode.gain.value = localStorage.effectVolume * 0.01;
                soundNote.connect(gainNode);
                gainNode.connect(context.destination);
                sound.play();
            }
            btnDown4 = true;
        }
    }

    //Entfärbung der Spieltasten
    window.onkeyup = function(e)
    {
        var key = e.keyCode ? e.keyCode : e.which;
        if(key == 68 && !gameOver && levelNr == 2 || levelNr == 3)
        {
            btn1.style.backgroundColor = "rgb(189, 207, 221)";
            btnDown1 = false;
        }
        if(key == 70 && !gameOver)
        {
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btnDown2 = false;
        }
        if(key == 74 && !gameOver)
        {
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
            btnDown3 = false;
        }
        if(key == 75 && !gameOver && levelNr == 3)
        {
            btn4.style.backgroundColor = "rgb(189, 207, 221)";
            btnDown4 = false;
        }
    }
	    
    //Berechnet neue Lückenpositionen    
    function calcFloor()
    {
        if(levelNr == 1)
        {
            for(var i = 0; i < data1.gaps.length; i++)
            {
                platforms[i] = platforms[i] - scrollSpeed;
            }
        }
        else if(levelNr == 2)
        {
            for(var i = 0; i < data2.gaps.length; i++)
            {
                platforms[i] = platforms[i] - scrollSpeed;
            }
        }
        else if(levelNr == 3)
        {
            for(var i = 0; i < data3.gaps.length; i++)
            {
                platforms[i] = platforms[i] - scrollSpeed;
            }
        }
    }
	    
    //Überprüft Trefferfehler bei Tastendruck, berechnet Punktzahl anhand von Genauigkeit, aktiviert Trefferpunkte Overlay und füllt Lebensbalken bei Treffer	    
    function checkHit(buttonCheck)
    {
        var hitError;
        var points;
        if(buttonCheck == 70 && platCol[activeGap] == "blue" || buttonCheck == 74 && platCol[activeGap] == "red"
            || buttonCheck == 68 && platCol[activeGap] == "green")
        {
            if(indicatorPosition > platforms[activeGap] -41 && indicatorPosition < platforms[activeGap] + gapWidth + 41)
            {
                if(cooldown == false)
                {
                    hitError = indicatorPosition - platforms[activeGap];
                    if(Math.abs(hitError) < 21)
                    {
                        points = 300;
                        document.getElementById("overlay300").style.display = "block";
                        document.getElementById("healthBar").value += 20;
                        hit300++;
                    }
                    else if(Math.abs(hitError) < 31)
                    {
                        points = 100;
                        document.getElementById("overlay100").style.display = "block";
                        document.getElementById("healthBar").value += 20;
                        hit100++;
                    }
                    else if(Math.abs(hitError) < 41)
                    {
                        points = 50;
                        document.getElementById("overlay50").style.display = "block";
                        document.getElementById("healthBar").value += 20;
                        hit50++;
                    }
                    else
                    {
                        points = 0;
                        document.getElementById("overlayMiss").style.display = "block";
                        hit0++;
                    }
                    overlayTimer = 1;
                    score += points;
                    message = "Score: " + score;
                    cooldown = true;
                }
            }
        }
    }
	    
    //Berechnung der nächsten zu treffenden Lücke
    function calcNextGap()
    {
        if((platforms[activeGap] + (platforms[activeGap + 1] - platforms[activeGap]) / 2) < indicatorPosition)
        {
            if(firstClickDone == false)
            {
                activeGap++;
                cooldown = false;
            }
        }
    }
	    
    //Füllt das Lücken-Array mit den Werten aus der Level-Datei	    
    function readLevelData()
    {
        if(levelNr == 1)
        {
            for(var i = 0; i < data1.gaps.length; i++)
            {
                var splitPos = data1.gaps[i].split("-");
                platPos[i] = parseInt(splitPos[1]);
                platCol[i] = splitPos[0];
                platforms[i] = firstNoteDistance + parseInt(splitPos[1]);
            }
        }
        else if(levelNr == 2)
        {
            for(var i = 0; i < data2.gaps.length; i++)
            {
                var splitPos = data2.gaps[i].split("-");
                platPos[i] = parseInt(splitPos[1]);
                platCol[i] = splitPos[0];
                platforms[i] = firstNoteDistance + parseInt(splitPos[1]);
            }
        }
        else if(levelNr == 3)
        {
            for(var i = 0; i < data3.gaps.length; i++)
            {
                var splitPos = data3.gaps[i].split("-");
                platPos[i] = parseInt(splitPos[1]);
                platCol[i] = splitPos[0];
                platforms[i] = firstNoteDistance + parseInt(splitPos[1]);
            }
        }
    }
	    
    //Beendet das Level und zeigt das Endresultat Overlay	    
    function levelEnd(result)
    {
        sourceBuffer.stop();
        gameOver = true;
        if(result == "dead")
        {
            document.getElementById("text").textContent = "Deine Lebenspunkte sind auf 0 gefallen\n\nPerfekter Treffer (300 Punkte): " + hit300 + "x\n"
            + "Guter Treffer (100 Punkte): " + hit100 + "x\n"
            + "Schwacher Treffer (50 Punkte): " + hit50 + "x\n"
            + "Nicht getroffen (0 Punkte): " + hit0 + "x\n\n"
            + "Score: " + score;
        }
        else if(result == "finish")
        {
            document.getElementById("text").textContent = "Endergebnis\n\nPerfekter Treffer (300 Punkte): " + hit300 + "x\n"
            + "Guter Treffer (100 Punkte): " + hit100 + "x\n"
            + "Schwacher Treffer (50 Punkte): " + hit50 + "x\n"
            + "Nicht getroffen (0 Punkte): " + hit0 + "x\n\n"
            + "Score: " + score;
        }
        document.getElementById("overlay").style.display = "block";
    }   
    </script>
</body>
</html>
