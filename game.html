<!DOCTYPE html>
<html lang = de>
<head>
	<Title>AVPRG</title>
    <meta charset=utf-8>
    <link rel=stylesheet href=stylesheet.css type=text/css>
    <script type="text/javascript" src="LevelData/wewillrockyou.js"></script>
    <script type="text/javascript" src="LevelData/level2.js"></script>
</head>
<body>
    <div id=overlay>
        <div id=text>End Result</div>
    </div>
    <canvas id=canvas width=1200 height=800></canvas>
    <div id=keyUI>
        <div class=playKeys id=playKey1>D</div>
        <div class=playKeys id=playKey2>F</div>
        <div class=playKeys id=playKey3>J</div>
        <div class=playKeys id=playKey4>K</div>
    </div>
    <script>
        const FPS = 30;
        const playerSize = 70;
        var btn1 = document.querySelector("#playKey1");
        var btn2 = document.querySelector("#playKey2");
        var btn3 = document.querySelector("#playKey3");
        var btn4 = document.querySelector("#playKey4");
        var scrollSpeed;  //Pixel pro Frame
        var gapWidth;
        var firstNoteDistance;
        var indicatorPosition = 0;
        var message = "Press F to hit the gap";
        var cooldown = false;
        var activeGap = 0;
        var firstClickDone = false;
        var score = 0;
        var endDelay = 0;
        var gameOver = false;
        var context = new AudioContext();
	    var request = new XMLHttpRequest();
        var sourceBuffer = context.createBufferSource();
        var btn1;
        var btn2;
        var btn3;
        var btn4;
        var levelNr;

        var hit300 = 0;
        var hit100 = 0;
        var hit50 = 0;
        var hit0 = 0;

	    var backgroundSound;
	    var backgroundDelay;

        var canv = document.getElementById("canvas");
        var ctx = canv.getContext("2d");
        
        ctx.font = "20px Arial";

        var player;

        var platforms = [];
        var platPos = [];
        var platCol = [];

        setup();
	    
    function setup()
    {
        player = 
        {
            x: canv.width / 8,
            y: canv.height / 2,
            width: playerSize,
            height: playerSize * 1.5
        }
        indicatorPosition = player.x * 2.2;
        
        if(window.location.href.includes("WeWillRockYou"))
        {
            levelNr = 1;
            //difficulty scale
            scrollSpeed = lvl1SS;
            gapWidth = lvl1GW;
            firstNoteDistance = lvl1FND;

            //background sound
            backgroundSound = lvl1BS;
            backgroundDelay = lvl1BD;

            //UI
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
        }
        else if(window.location.href.includes("Level2"))
        {
            levelNr = 2;
            //difficulty scale
            scrollSpeed = lvl2SS;
            gapWidth = lvl2GW;
            firstNoteDistance = lvl2FND;

            //background sound
            backgroundSound = lvl2BS;
            backgroundDelay = lvl2BD;

            //UI
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
            btn4.style.backgroundColor = "rgb(189, 207, 221)";
        }

        readLevelData();

        request.open('GET', backgroundSound, true);
	    request.responseType = 'arraybuffer';
        request.onload = function () 
        {
	    	var undecodedAudio = request.response;
            context.decodeAudioData(undecodedAudio, function (buffer) 
            {
	    		sourceBuffer.buffer = buffer;
	    		sourceBuffer.connect(context.destination);
                sourceBuffer.start(context.currentTime +backgroundDelay);
	    	});
	    };
        request.send();

        //Gameloop
        setInterval(update, 1000 / FPS);
    }

    function update()
    {
        //message = activeGap;
        
        //draw background
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canv.width, canv.height);

        //draw backgroundplatform
        ctx.fillStyle = "white";
        ctx.fillRect(0, player.y+playerSize / 20, canv.width, 30);

        //draw text
        ctx.fillStyle = "white";
        ctx.fillText(message, canv.width - 400, 50);

        //draw player
        ctx.fillStyle = "green";
        ctx.fillRect(player.x, player.y - player.height, player.width, player.height);
        ctx.strokeStyle = "white";
        ctx.lineWidth = playerSize / 20;
        ctx.beginPath();
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + player.width, player.y);
        ctx.lineTo(player.x + player.width, player.y - player.height);
        ctx.lineTo(player.x, player.y - player.height);
        ctx.lineTo(player.x, player.y);
        ctx.stroke();
        
        //calculate new platform position
        calcFloor();
        calcNextGap();

        //draw platform
        for(var i = 0; i < platforms.length; i++)
        {
            if(platforms[i] < canv.width && platforms[i] > 0 - gapWidth)
            {
                ctx.fillStyle = platCol[i]; 
                ctx.fillRect(platforms[i], player.y+playerSize / 20, gapWidth, 30);
            }
        }

        //draw indicator
        ctx.strokeStyle = "red";
        ctx.lineWidth = playerSize / 10;
        ctx.beginPath();
        ctx.moveTo(player.x * 2.2, player.y - player.height * 1.5);
        ctx.lineTo(player.x * 2.2, player.y + player.height / 2);

        ctx.stroke();

        /*if(platPos[activeGap] +51 < indicatorPosition && cooldown == false)
        {
            console.log("nop");
            hit0++;
            cooldown = true;
        }*/

        if(activeGap == platforms.length - 1)
        {
            endDelay++;
            if(endDelay == platforms.length)levelEnd();
        }
    }

    window.onkeyup = function(e)
    {
        var key = e.keyCode ? e.keyCode : e.which;
        if(key == 68 && !gameOver && levelNr == 3)
        {
            btn1.style.backgroundColor = "rgb(189, 207, 221)";
        }
        if(key == 70 && !gameOver)
        {
            btn2.style.backgroundColor = "rgb(189, 207, 221)";
        }
        if(key == 74 && !gameOver)
        {
            btn3.style.backgroundColor = "rgb(189, 207, 221)";
        }
        if(key == 75 && !gameOver && levelNr == 2 || levelNr == 3)
        {
            btn4.style.backgroundColor = "rgb(189, 207, 221)";
        }
    }
    window.onkeydown = function(e)
    {
        var key = e.keyCode ? e.keyCode : e.which;

        if(key == 27)
        {
            document.getElementById("overlay").style.display = "none";
        }
        if(key == 68 && !gameOver && levelNr == 3)
        {
            btn1.style.backgroundColor = "lightcoral";
            checkHit(70);                                                           //HIER NOCH ÄNDERN 
            var context = new AudioContext();
            sound = new Audio("sounds/We will Rock you/Beat.mp3");                  //DAS HIER ALLES RAUS DAMIT ES NICHT IMMER WIEDER BERECHNET WIRD
            soundNote = context.createMediaElementSource(sound);
            var gainNode = context.createGain();
            gainNode.gain.value = 0.8;
            soundNote.connect(gainNode);
            gainNode.connect(context.destination);
            sound.play();
        }
        if(key == 70 && !gameOver)
        {
            btn2.style.backgroundColor = "lightcoral";
            checkHit(70);
            var context = new AudioContext();
            sound = new Audio("sounds/We will Rock you/Beat.mp3");
            soundNote = context.createMediaElementSource(sound);
            var gainNode = context.createGain();
            gainNode.gain.value = 0.8;
            soundNote.connect(gainNode);
            gainNode.connect(context.destination);
            sound.play();
        }
        if(key == 74 && !gameOver)
        {
            btn3.style.backgroundColor = "lightcoral";
            checkHit(74);
            var context = new AudioContext();
            sound = new Audio("sounds/We will Rock you/Clapp.mp3");
            soundNote = context.createMediaElementSource(sound);
            var gainNode = context.createGain();
            gainNode.gain.value = 0.8;
            soundNote.connect(gainNode);
            gainNode.connect(context.destination);
            sound.play();
        }
        if(key == 75 && !gameOver && levelNr == 2 || levelNr == 3)
        {
            btn4.style.backgroundColor = "lightcoral";
            checkHit(74);                                                           //HIER NOCH ÄNDERN
            var context = new AudioContext();
            sound = new Audio("sounds/We will Rock you/Clapp.mp3");
            soundNote = context.createMediaElementSource(sound);
            var gainNode = context.createGain();
            gainNode.gain.value = 0.8;
            soundNote.connect(gainNode);
            gainNode.connect(context.destination);
            sound.play();
        }
    }
    function calcFloor()
    {
        if(levelNr == 1)
        {
            for(var i = 0; i < data1.gaps.length; i++)
            {
                platforms[i] = platforms[i] - scrollSpeed;
            }
        }
        else if(levelNr == 2)
        {
            for(var i = 0; i < data2.gaps.length; i++)
            {
                platforms[i] = platforms[i] - scrollSpeed;
            }
        }
    }
    function checkHit(buttonCheck)
    {
        var hitError;
        var points;
        var rewardMessage;
        if(buttonCheck == 70 && platCol[activeGap] == "blue" || buttonCheck == 74 && platCol[activeGap] == "red")
        {
            if(indicatorPosition > platforms[activeGap] -51 && indicatorPosition < platforms[activeGap] +51)
            {
                if(cooldown == false)
                {
                    hitError = indicatorPosition - platforms[activeGap];
                    if(Math.abs(hitError) < 11)
                    {
                        points = 300;
                        rewardMessage = "Perfect Hit!";
                        hit300++;
                    }
                    else if(Math.abs(hitError) < 21)
                    {
                        points = 100;
                        rewardMessage = "Good Hit!";
                        hit100++;
                    }
                    else if(Math.abs(hitError) < 31)
                    {
                        points = 50;
                        rewardMessage = "Poor Hit!";
                        hit50++;
                    }
                    else
                    {
                        points = 0;
                        rewardMessage = "Miss!";
                        hit0++;
                    }
                    score += points;
                    message = hitError + " = " + rewardMessage + " (" + points + ") ----- Score: " + score;
                    cooldown = true;
                }
            }
        }
    }
    function calcNextGap()
    {
        if((platforms[activeGap] + (platforms[activeGap + 1] - platforms[activeGap]) / 2) < indicatorPosition)
        {
            if(firstClickDone == false)
            {
                activeGap++;
                cooldown = false;
            }
        }
    }
    function readLevelData()
    {
        if(levelNr == 1)
        {
            for(var i = 0; i < data1.gaps.length; i++)
            {
                var splitPos = data1.gaps[i].split("-");
                platPos[i] = parseInt(splitPos[1]);
                platCol[i] = splitPos[0];
                platforms[i] = firstNoteDistance + parseInt(splitPos[1]);
            }
        }
        else if(levelNr == 2)
        {
            for(var i = 0; i < data2.gaps.length; i++)
            {
                var splitPos = data2.gaps[i].split("-");
                platPos[i] = parseInt(splitPos[1]);
                platCol[i] = splitPos[0];
                platforms[i] = firstNoteDistance + parseInt(splitPos[1]);
            }
        }
        
        
        /*var c = 1;
        var n = -220;
        var col = "blue";

        for(var i = 0; i < 45; i++)
        {
            //console.log(platforms[i]);
            if(c == 1)
            {
                col = "blue";
                n += 220;
            }
            else if(c == 2)
            {
                col = "blue";
                n += 110;
            }
            else if(c == 3)
            {
                col = "red";
                n += 110;
                c = 0;
            }
            console.log("\"" + col + "-" + n + "\",");
            c++;
        }*/
    }
    function levelEnd()
    {
        sourceBuffer.stop();
        gameOver = true;
        document.getElementById("text").textContent = "End Result\n\nPerfect Hit (300 points): " + hit300 + "x\n"
            + "Good Hit (100 points): " + hit100 + "x\n"
            + "Poor Hit (50 points): " + hit50 + "x\n"
            + "Miss (0 points): " + hit0 + "x\n\n"
            + "Score: " + score;
        document.getElementById("overlay").style.display = "block";
    }

	    
	    //Play Soundfile
        /*document.getElementById("Button1").addEventListener("click", function() {
        
        document.getElementById("outputText").innerHTML = "Test1";
        var context = new AudioContext(),
        sound = new Audio("sounds/sound1.wav"),
        soundNote = context.createMediaElementSource(sound);
        var gainNode = context.createGain();
        gainNode.gain.value = 0.8;
        soundNote.connect(gainNode);
        gainNode.connect(context.destination);
        sound.play();
        }); */
	    
	    // oscillator
	    
	  /*  var context = new AudioContext();
	var oscillatorNode = context.createOscillator();
	oscillatorNode.connect(context.destination);
	oscillatorNode.frequency.value = 880;
	oscillatorNode.type = "square";
	oscillatorNode.start(context.currentTime);
	oscillatorNode.stop(context.currentTime + 1);*/
	    
	// oscillator + gain
	    
	   /*var context = new AudioContext();
		var oscillatorNode = context.createOscillator();
		var gainNode = context.createGain();
		oscillatorNode.connect(gainNode);
	    	oscillatorNode.frequency.value = 880;
		oscillatorNode.type = "square";
		gainNode.connect(context.destination);
		gainNode.gain.value = 0.001;
		oscillatorNode.start(context.currentTime);
		oscillatorNode.stop(context.currentTime + 1);*/
	    
	    
	    //Theremin
	  /* var context = new AudioContext();
		oscillator = null
		mousedown = false
		gainNode = context.createGain();
	    document.body.addEventListener('mousedown', function(e){
		mousedown = true;
		oscillator = context.createOscillator();
		oscillator.connect(gainNode);
		gainNode.connect(context.destination);
		calculateFreqAndGain(e);
		oscillator.start(context.currentTime);
	    });
	    
	 function calculateFreqAndGain(e) {
		var maxFreq = 2000;
		    minFreq = 20;
		    maxGain = 1;
		    minGain = 0;
		oscillator.frequency.value = (((e.clientX / window.innerWidth) * maxFreq) + minFreq);
		gainNode.gain.value = (((e.clientY / window.innerHeight) * maxGain) + minGain);
		 
		oscillator.frequency.setTargetAtTime((((e.clientX / window.innerWidth) * maxFreq) + minFreq), context.currentTime, 0.01);
	    }*/
	    
    </script>
</body>
</html>
